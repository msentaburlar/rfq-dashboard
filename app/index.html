<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Datenanalyse & Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --primary:#2563eb; --primary-hover:#1d4ed8;
      --danger:#e74c3c; --danger-hover:#cf3d30;
      --bg:#f4f6f9; --card-bg:#fff; --border:#e9edf3;
      --text:#1f2937; --text-muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);}
    .app{display:grid;grid-template-columns:420px 1fr;height:100vh;gap:16px;padding:16px;}
    @media (max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:1fr 1fr;}}
    .panel{background:var(--card-bg);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column;}
    .header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800;background:var(--card-bg);}
    .sub{font-weight:500;color:var(--text-muted);font-size:12px;margin-top:4px;}

    .chatlog{padding:14px 16px;overflow:auto;flex:1;}
    .msg{margin:10px 0;padding:10px 14px;border-radius:12px;max-width:90%;line-height:1.45;font-size:14px;}
    .user{background:#e8f0ff;margin-left:auto;}
    .bot{background:#f3f4f6;}
    .bot.success{background:#f0fdf4;color:#166534;}
    .bot.error{background:#fef2f2;color:#b91c1c;}

    .composer{padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--card-bg);}
    textarea{flex:1;resize:none;border:1px solid #d6dde8;border-radius:10px;padding:12px;height:48px;outline:none;font-family:inherit;}
    button{border:0;background:var(--primary);color:white;padding:0 16px;border-radius:10px;font-weight:800;cursor:pointer;height:48px;}
    button:hover:not(:disabled){background:var(--primary-hover);}
    button:disabled{opacity:.6;cursor:not-allowed;}

    .out{padding:14px 16px;overflow:auto;flex:1;}
    .card{border:1px solid var(--border);border-radius:12px;padding:14px;margin:10px 0;background:var(--card-bg);}
    .tag{display:inline-block;font-size:11px;font-weight:700;padding:3px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;}
    .tag.dashboard{background:#f0fdf4;color:#166534;}
    .tag.error{background:#fef2f2;color:#b91c1c;}
    .answer-content{line-height:1.7;font-size:14px;}

    .loading{display:flex;align-items:center;gap:8px;color:var(--text-muted);font-size:13px;}
    .spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* Filterbar (RECHTS im Dashboard) */
    .dash-filterbar{
      display:flex;
      gap:14px;
      align-items:flex-end;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      background:var(--card-bg);
      flex-wrap:wrap;
    }
    .field{display:flex;flex-direction:column;gap:6px;}
    .label{font-size:12px;color:var(--text-muted);font-weight:800;}
    select{
      height:40px;border:1px solid #d6dde8;border-radius:10px;padding:0 10px;background:#fff;
      font-weight:700;
    }
    .btnrow{display:flex;gap:10px;align-items:center;margin-left:auto;}
    .btn-run{background:var(--primary);height:40px;}
    .btn-run:hover{background:var(--primary-hover);}
    .btn-reset{background:var(--danger);height:40px;}
    .btn-reset:hover{background:var(--danger-hover);}
    .btn-run,.btn-reset{padding:0 16px;border-radius:10px;font-weight:900;}
  </style>
</head>

<body>
<div class="app">

  <!-- LEFT: CHAT -->
  <div class="panel">
    <div class="header">
      Datenanalyse
      <div class="sub">Frage stellen â€“ Dashboard rechts aktualisieren</div>
    </div>

    <div id="chatlog" class="chatlog">
      <div class="msg bot">Schreibe eine Frage. Die Filter sind rechts im Dashboard.</div>
    </div>

    <div class="composer">
      <textarea id="input" placeholder="Schreibe deine Frage..."></textarea>
      <button id="send">Senden</button>
    </div>
  </div>

  <!-- RIGHT: OUTPUT + FILTERS -->
  <div class="panel">
    <div class="header">
      Ergebnis
      <div class="sub">Analyse & Dashboard</div>
    </div>

    <!-- âœ… FILTERS SIND JETZT HIER (im Dashboard rechts) -->
    <div class="dash-filterbar">
      <div class="field">
        <div class="label">Jahr</div>
        <select id="yearSel">
          <option value="">Alle Jahre</option>
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
        </select>
      </div>

      <div class="field">
        <div class="label">Monat</div>
        <select id="monthSel" disabled>
          <option value="">Alle Monate</option>
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">MÃ¤r</option>
          <option value="4">Apr</option><option value="5">Mai</option><option value="6">Jun</option>
          <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
          <option value="10">Okt</option><option value="11">Nov</option><option value="12">Dez</option>
        </select>
      </div>

      <div class="btnrow">
        <button id="runBtn" class="btn-run" title="Aktualisiert nur bei Klick">AusfÃ¼hren</button>
        <button id="resetBtn" class="btn-reset" title="Filter leeren und sofort neu laden">ZurÃ¼cksetzen</button>
      </div>
    </div>

    <div id="output" class="out">
      <div class="card">Noch keine Antwort.</div>
    </div>
  </div>

</div>

<script>
  // ============================================================
  // KONFIGURATION
  // ============================================================
  const CONFIG = {
    WEBHOOK_URL: "https://yraq0l4j.rpcld.cc/webhook/rfq-chat",
    TIMEOUT: 120000
  };

  marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });

  const chatlog = document.getElementById('chatlog');
  const output  = document.getElementById('output');
  const input   = document.getElementById('input');
  const sendBtn = document.getElementById('send');

  const yearSel  = document.getElementById('yearSel');
  const monthSel = document.getElementById('monthSel');
  const runBtn   = document.getElementById('runBtn');
  const resetBtn = document.getElementById('resetBtn');

  let chartInstances = {};

  function addMsg(role, text, extraClass = '') {
    const div = document.createElement('div');
    div.className = `msg ${role} ${extraClass}`.trim();
    div.innerHTML = text;
    chatlog.appendChild(div);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  function showLoading() {
    output.innerHTML = `
      <div class="card">
        <div class="loading">
          <div class="spinner"></div>
          <span>Verarbeite Anfrage...</span>
        </div>
      </div>
    `;
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function showTextAnswer(text) {
    output.innerHTML = `
      <div class="card">
        <div class="tag">Antwort</div>
        <div class="answer-content">${marked.parse(text || "")}</div>
      </div>
    `;
  }

  function showDashboardUpdate(payload) {
    const title = payload.title || "Dashboard";
    const answer = payload.answer || "";

    output.innerHTML = `
      <div class="card">
        <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>
        ${answer ? `<div class="answer-content">${marked.parse(answer)}</div>` : ""}
        <div id="kpi-grid"></div>
        <div id="charts-area"></div>
        <div id="table-area"></div>
      </div>
    `;

    renderKpis(payload.kpis || []);
    renderCharts(payload.charts || []);
    renderTable(payload.table || null);
  }

  function renderKpis(kpis) {
    const el = document.getElementById("kpi-grid");
    if (!el) return;
    if (!kpis.length) { el.innerHTML = ""; return; }

    el.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px;">
        ${kpis.map(k => `
          <div style="border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;">
            <div style="font-size:12px;color:var(--text-muted);font-weight:800;">${escapeHtml(k.label || "")}</div>
            <div style="font-size:22px;font-weight:950;margin-top:6px;">${escapeHtml(k.value || "")}</div>
          </div>
        `).join("")}
      </div>
    `;
  }

  function renderCharts(charts) {
    const el = document.getElementById("charts-area");
    if (!el) return;

    Object.values(chartInstances).forEach(ch => { try { ch.destroy(); } catch(e) {} });
    chartInstances = {};

    if (!charts.length) { el.innerHTML = ""; return; }

    el.innerHTML = charts.map((c, idx) => {
      const id = c.id || ("chart" + (idx+1));
      return `
        <div style="margin-top:14px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;">
          <div style="font-weight:950;margin-bottom:10px;">${escapeHtml(c.title || ("Chart " + (idx+1)))}</div>
          <div style="height:280px;"><canvas id="${escapeHtml(id)}"></canvas></div>
        </div>
      `;
    }).join("");

    charts.forEach((c, idx) => {
      const id = c.id || ("chart" + (idx+1));
      const canvas = document.getElementById(id);
      if (!canvas) return;

      const chartType = (c.chartType || "bar").toLowerCase();
      const labels = c.labels || [];
      const series = c.series || [];
      const datasets = series.map(s => ({
        label: s.name || "Serie",
        data: (s.data || []).map(v => (typeof v === "string" ? Number(v) : v))
      }));

      chartInstances[id] = new Chart(canvas.getContext("2d"), {
        type: chartType,
        data: { labels, datasets },
        options: { responsive: true, maintainAspectRatio: false }
      });
    });
  }

  function renderTable(table) {
    const el = document.getElementById("table-area");
    if (!el) return;

    if (!table || !table.columns || !table.rows) { el.innerHTML = ""; return; }

    el.innerHTML = `
      <div style="margin-top:14px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;">
        <div style="padding:10px 12px;font-weight:950;border-bottom:1px solid var(--border);">Tabelle</div>
        <div class="answer-content" style="padding:0;">
          <table style="width:100%;border-collapse:collapse;">
            <thead style="background:#f3f4f6;">
              <tr>${table.columns.map(col => `<th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);">${escapeHtml(col)}</th>`).join("")}</tr>
            </thead>
            <tbody>
              ${table.rows.map(r => `
                <tr>${r.map(cell => `<td style="padding:10px 12px;border-bottom:1px solid var(--border);">${escapeHtml(String(cell))}</td>`).join("")}</tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  // ============================================================
  // Monat deaktiviert bis Jahr gewÃ¤hlt
  // ============================================================
  function syncMonthEnabled() {
    const y = yearSel.value;
    monthSel.disabled = !y;
    if (!y) monthSel.value = "";
  }
  yearSel.addEventListener("change", syncMonthEnabled);
  syncMonthEnabled();

  // ============================================================
  // Robust JSON Parsing
  // ============================================================
  function parseN8nResponse(rawText) {
    if (!rawText || rawText.trim() === '') {
      return { type: "text", answer: "Leere Antwort vom Server erhalten." };
    }
    try {
      const parsed = JSON.parse(rawText);
      if (parsed && typeof parsed === "object" && typeof parsed.output === "string") {
        try { return JSON.parse(parsed.output); } catch {}
      }
      return parsed;
    } catch {
      return { type: "text", answer: rawText };
    }
  }

  async function callN8N(payload) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

    try {
      const response = await fetch(CONFIG.WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      const rawText = await response.text();
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${rawText || 'Keine Details'}`);
      return parseN8nResponse(rawText);

    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') throw new Error('Timeout: Die Anfrage hat zu lange gedauert.');
      throw error;
    }
  }

  // ============================================================
  // AusfÃ¼hren / ZurÃ¼cksetzen (rechts im Dashboard)
  // ============================================================
  async function runQuery(message, { auto = false } = {}) {
    const filters = {
      year: yearSel.value ? Number(yearSel.value) : null,
      month: monthSel.value ? Number(monthSel.value) : null
    };

    const msg = (message || "").trim() || "Erstelle ein Dashboard basierend auf den ausgewÃ¤hlten Filtern.";

    if (!auto) addMsg('user', escapeHtml(msg));
    showLoading();
    sendBtn.disabled = true;
    runBtn.disabled = true;
    resetBtn.disabled = true;

    try {
      const response = await callN8N({
        message: msg,
        filters,
        timestamp: new Date().toISOString()
      });

      if (response.type === "dashboard_update") {
        addMsg('bot', 'Dashboard aktualisiert', 'success');
        showDashboardUpdate(response);
      } else {
        addMsg('bot', 'Antwort erhalten âœ“');
        showTextAnswer(response.answer || JSON.stringify(response, null, 2));
      }
    } catch (e) {
      addMsg('bot', `âŒ ${escapeHtml(e.message)}`, 'error');
      showTextAnswer(e.message);
    } finally {
      sendBtn.disabled = false;
      runBtn.disabled = false;
      resetBtn.disabled = false;
      input.focus();
    }
  }

  runBtn.addEventListener("click", () => {
    runQuery(input.value);
    input.value = "";
  });

  resetBtn.addEventListener("click", () => {
    yearSel.value = "";
    monthSel.value = "";
    syncMonthEnabled();
    runQuery("", { auto: true }); // sofort neu laden
  });

  // ============================================================
  // Senden (Chat)
  // ============================================================
  async function onSend() {
    const msg = input.value.trim();
    if (!msg) return;
    input.value = "";
    await runQuery(msg);
  }

  sendBtn.addEventListener('click', onSend);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); onSend(); }
  });

  input.focus();
</script>
</body>
</html>
