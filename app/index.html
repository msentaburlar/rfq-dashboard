<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RFQ Chat + Dashboard</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f4f6f9; }
    .app { display: grid; grid-template-columns: 420px 1fr; height: 100vh; gap: 16px; padding: 16px; box-sizing: border-box; }
    .panel { background: white; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); overflow: hidden; display:flex; flex-direction:column; }
    .header { padding: 14px 16px; border-bottom: 1px solid #e9edf3; font-weight: 700; background: #ffffff; }
    .sub { font-weight: 500; color:#6b7280; font-size: 12px; margin-top: 4px; }
    .chatlog { padding: 14px 16px; overflow:auto; flex:1; }
    .msg { margin: 10px 0; padding: 10px 12px; border-radius: 12px; max-width: 95%; line-height: 1.35; }
    .user { background:#e8f0ff; margin-left:auto; }
    .bot { background:#f3f4f6; }
    .composer { padding: 12px; border-top: 1px solid #e9edf3; display:flex; gap: 10px; }
    textarea { flex:1; resize:none; border:1px solid #d6dde8; border-radius: 10px; padding: 10px; height: 44px; outline:none; }
    button { border:0; background:#2563eb; color:white; padding: 0 14px; border-radius: 10px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .out { padding: 14px 16px; overflow:auto; flex:1; }
    .card { border:1px solid #e9edf3; border-radius: 12px; padding: 12px; margin: 10px 0; background:#fff; }
    .tag { display:inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#eef2ff; color:#3730a3; margin-bottom:8px; }
    iframe { width: 100%; height: 70vh; border: 1px solid #e9edf3; border-radius: 12px; background: #fff; }
    .hint { color:#6b7280; font-size: 13px; }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: CHAT -->
    <div class="panel">
      <div class="header">
        RFQ Chat
        <div class="sub">Frage stellen → Antwort/Dashboard rechts</div>
      </div>

      <div id="chatlog" class="chatlog">
        <div class="msg bot">Hi! Frag z.B. „Gib mir die gesamte Anzahl von RFQs“ oder „Erstelle mir ein Dashboard“.</div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Schreibe deine Frage..."></textarea>
        <button id="send">Senden</button>
      </div>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="panel">
      <div class="header">
        Output
        <div class="sub">Text oder Dashboard wird hier angezeigt</div>
      </div>

      <div id="output" class="out">
        <div class="hint">Noch keine Antwort. Sende links eine Frage.</div>
      </div>
    </div>
  </div>

  <script>
    const chatlog = document.getElementById('chatlog');
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
    }

    function showTextAnswer(text) {
      output.innerHTML = `
        <div class="card">
          <div class="tag">Antwort</div>
          <div>${escapeHtml(text).replaceAll('\\n','<br>')}</div>
        </div>
      `;
    }

    function showDashboard(url) {
      output.innerHTML = `
        <div class="card">
          <div class="tag">Dashboard</div>
          <div class="hint">Eingebettet via iframe:</div>
          <div style="margin-top:10px;">
            <iframe src="${url}"></iframe>
          </div>
        </div>
      `;
    }

    function escapeHtml(str){
      return str.replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'","&#039;");
    }

    // ✅ Backend Call (robust): liest erst Text, parst dann JSON – stürzt nie ab
    async function callN8N(message){
      const WEBHOOK_URL = "https://yraq0l4j.rpcld.cc/webhook/269a0806-c637-4568-aab4-a1a339b5a80d/chat";


      const r = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });

      // Wir lesen IMMER zuerst Text, damit "leere" oder ungültige Antworten nicht crashen
      const raw = await r.text();

      // Wenn HTTP nicht ok ist, Fehler mit Rohtext werfen (super fürs Debugging)
      if(!r.ok){
        throw new Error("n8n HTTP " + r.status + (raw ? (": " + raw) : ""));
      }

      // Versuche JSON zu parsen; wenn das nicht geht, gib Debug-Info zurück
      try {
        return raw
          ? JSON.parse(raw)
          : { type: "text", answer: "Leere Antwort vom Server." };
      } catch (e) {
        return { type: "text", answer: "Ungültiges JSON vom Server:\n" + raw };
      }
    }

    async function onSend(){
      const msg = input.value.trim();
      if(!msg) return;
      input.value = '';
      addMsg('user', msg);
      sendBtn.disabled = true;

      try{
        const res = await callN8N(msg);

        if(res.type === "text"){
          addMsg('bot', res.answer || "");
          showTextAnswer(res.answer || "");
        } else if(res.type === "dashboard"){
          addMsg('bot', `Dashboard bereit: ${res.title || "Dashboard"}`);
          showDashboard(res.url);
        } else {
          addMsg('bot', 'Unbekanntes Antwortformat.');
          showTextAnswer('Unbekanntes Antwortformat.');
        }
      } catch(e){
        addMsg('bot', 'Fehler: ' + e.message);
        showTextAnswer('Fehler: ' + e.message);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', onSend);
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        onSend();
      }
    });
  </script>
</body>
</html>
