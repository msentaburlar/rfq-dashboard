<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Datenanalyse & Dashboard</title>

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --border: #e9edf3;
      --text: #1f2937;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); }

    .app {
      display: grid;
      grid-template-columns: 420px 1fr;
      height: 100vh;
      gap: 16px;
      padding: 16px;
    }

    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
    }

    .sub {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .chatlog { padding: 14px 16px; overflow: auto; flex: 1; }

    .msg {
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 90%;
      line-height: 1.45;
      font-size: 14px;
    }

    .user { background: #e8f0ff; margin-left: auto; }
    .bot { background: #f3f4f6; }
    .bot.success { background: #f0fdf4; color: #166534; }
    .bot.error { background: #fef2f2; color: #b91c1c; }

    .composer {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    textarea {
      flex: 1;
      resize: none;
      border: 1px solid #d6dde8;
      border-radius: 10px;
      padding: 12px;
      height: 48px;
      outline: none;
      font-family: inherit;
    }

    button {
      border: 0;
      background: var(--primary);
      color: white;
      padding: 0 20px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .out { padding: 14px 16px; overflow: auto; flex: 1; }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin: 10px 0;
      background: var(--card-bg);
    }

    .tag {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 8px;
      display: inline-block;
      color: #166534;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th { background: #f3f4f6; }

    canvas { max-height: 260px; }
  </style>
</head>

<body>
<div class="app">

  <!-- CHAT -->
  <div class="panel">
    <div class="header">
      Datenanalyse
      <div class="sub">Frage stellen ‚Äì Analyse & Visualisierung erhalten</div>
    </div>

    <div id="chatlog" class="chatlog">
      <div class="msg bot">Stelle eine Frage oder bitte um ein Dashboard.</div>
    </div>

    <div class="composer">
      <textarea id="input" placeholder="Deine Frage..."></textarea>
      <button id="send">Senden</button>
    </div>
  </div>

  <!-- OUTPUT -->
  <div class="panel">
    <div class="header">
      Ergebnis
      <div class="sub">Analyse & Dashboard</div>
    </div>
    <div id="output" class="out">
      <div class="card">Noch keine Anfrage.</div>
    </div>
  </div>

</div>

<script>
const WEBHOOK_URL = "https://yraq0l4j.rpcld.cc/webhook/rfq-chat";

const chatlog = document.getElementById("chatlog");
const output = document.getElementById("output");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");

let chartInstances = {};

function addMsg(role, text, cls="") {
  const d = document.createElement("div");
  d.className = `msg ${role} ${cls}`;
  d.textContent = text;
  chatlog.appendChild(d);
  chatlog.scrollTop = chatlog.scrollHeight;
}

function showText(text) {
  output.innerHTML = `<div class="card">${marked.parse(text)}</div>`;
}

function showDashboard(data) {
  output.innerHTML = `
    <div class="card">
      <div class="tag">üìä Dashboard</div>
      ${data.answer ? `<div>${marked.parse(data.answer)}</div>` : ""}
      <div id="kpis"></div>
      <div id="charts"></div>
      <div id="table"></div>
    </div>
  `;

  renderKpis(data.kpis || []);
  renderCharts(data.charts || []);
  renderTable(data.table);
}

function renderKpis(kpis) {
  if (!kpis.length) return;
  document.getElementById("kpis").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:12px;">
      ${kpis.map(k => `
        <div class="card">
          <div style="font-size:12px;color:#666">${k.label}</div>
          <div style="font-size:22px;font-weight:800">${k.value}</div>
        </div>
      `).join("")}
    </div>
  `;
}

function renderCharts(charts) {
  Object.values(chartInstances).forEach(c => c.destroy());
  chartInstances = {};

  const el = document.getElementById("charts");
  if (!charts.length) return;

  el.innerHTML = charts.map((c,i)=>`
    <div class="card">
      <strong>${c.title || "Chart"}</strong>
      <canvas id="chart_${i}"></canvas>
    </div>
  `).join("");

  charts.forEach((c,i)=>{
    chartInstances[i] = new Chart(
      document.getElementById(`chart_${i}`),
      {
        type: c.chartType || "bar",
        data: {
          labels: c.labels,
          datasets: c.series.map(s => ({
            label: s.name,
            data: s.data
          }))
        }
      }
    );
  });
}

function renderTable(table) {
  if (!table || !table.rows) return;
  document.getElementById("table").innerHTML = `
    <div class="card">
      <strong>Tabelle</strong>
      <table>
        <thead>
          <tr>${table.columns.map(c=>`<th>${c}</th>`).join("")}</tr>
        </thead>
        <tbody>
          ${table.rows.map(r=>`
            <tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

async function send() {
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";
  addMsg("user", msg);
  sendBtn.disabled = true;
  output.innerHTML = `<div class="card">‚è≥ Verarbeitung‚Ä¶</div>`;

  try {
    const res = await fetch(WEBHOOK_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ message: msg })
    });
    const data = await res.json();

    if (data.type === "text") {
      addMsg("bot","Antwort erhalten","success");
      showText(data.answer || "");
    } else if (data.type === "dashboard_update") {
      addMsg("bot","Dashboard aktualisiert","success");
      showDashboard(data);
    } else {
      showText(JSON.stringify(data,null,2));
    }
  } catch(e) {
    addMsg("bot","Fehler","error");
    showText(e.message);
  } finally {
    sendBtn.disabled = false;
  }
}

sendBtn.onclick = send;
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
});
</script>
</body>
</html>
