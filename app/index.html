<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RFQ Chat + Dashboard</title>
  <style>
    :root { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --border: #e9edf3;
      --text: #1f2937;
      --text-muted: #6b7280;
    }
    
    * { box-sizing: border-box; }
    
    body { margin: 0; background: var(--bg); color: var(--text); }
    
    .app { 
      display: grid; 
      grid-template-columns: 420px 1fr; 
      height: 100vh; 
      gap: 16px; 
      padding: 16px;
    }
    
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
    }
    
    .panel { 
      background: var(--card-bg); 
      border-radius: 14px; 
      box-shadow: 0 6px 18px rgba(0,0,0,.06); 
      overflow: hidden; 
      display: flex; 
      flex-direction: column;
    }
    
    .header { 
      padding: 14px 16px; 
      border-bottom: 1px solid var(--border); 
      font-weight: 700; 
      background: var(--card-bg);
    }
    
    .sub { 
      font-weight: 500; 
      color: var(--text-muted); 
      font-size: 12px; 
      margin-top: 4px;
    }
    
    /* Chat Log */
    .chatlog { 
      padding: 14px 16px; 
      overflow: auto; 
      flex: 1;
    }
    
    .msg { 
      margin: 10px 0; 
      padding: 10px 14px; 
      border-radius: 12px; 
      max-width: 90%; 
      line-height: 1.45;
      font-size: 14px;
    }
    
    .user { 
      background: #e8f0ff; 
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .bot { 
      background: #f3f4f6;
      border-bottom-left-radius: 4px;
    }
    
    .bot.error { background: #fef2f2; color: #b91c1c; }
    .bot.success { background: #f0fdf4; color: #166534; }
    
    /* Composer */
    .composer { 
      padding: 12px; 
      border-top: 1px solid var(--border); 
      display: flex; 
      gap: 10px;
    }
    
    textarea { 
      flex: 1; 
      resize: none; 
      border: 1px solid #d6dde8; 
      border-radius: 10px; 
      padding: 12px; 
      height: 48px; 
      outline: none;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    textarea:focus { border-color: var(--primary); }
    
    button { 
      border: 0; 
      background: var(--primary); 
      color: white; 
      padding: 0 20px; 
      border-radius: 10px; 
      font-weight: 700; 
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover:not(:disabled) { background: var(--primary-hover); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    
    /* Output Panel */
    .out { 
      padding: 14px 16px; 
      overflow: auto; 
      flex: 1;
    }
    
    .card { 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 14px; 
      margin: 10px 0; 
      background: var(--card-bg);
    }
    
    .tag { 
      display: inline-block; 
      font-size: 11px; 
      font-weight: 600;
      padding: 3px 10px; 
      border-radius: 999px; 
      background: #eef2ff; 
      color: #3730a3; 
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tag.dashboard { background: #f0fdf4; color: #166534; }
    .tag.error { background: #fef2f2; color: #b91c1c; }
    
    .hint { color: var(--text-muted); font-size: 13px; }
    
    /* Dashboard Container */
    .dashboard-container {
      width: 100%;
      min-height: 500px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      overflow: auto;
    }
    
    .dashboard-container iframe {
      width: 100%;
      height: 70vh;
      border: none;
      border-radius: 12px;
    }
    
    /* Loading Spinner */
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Text Answer Formatting */
    .answer-text {
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .answer-text strong { color: var(--primary); }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: CHAT -->
    <div class="panel">
      <div class="header">
        RFQ Chat
        <div class="sub">Frage stellen â†’ Antwort/Dashboard rechts</div>
      </div>

      <div id="chatlog" class="chatlog">
        <div class="msg bot">
          Hi! Frag z.B. â€žGib mir die gesamte Anzahl von RFQs" oder â€žErstelle mir ein Dashboard mit RFQs als Balkendiagramm".
        </div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Schreibe deine Frage..."></textarea>
        <button id="send">Senden</button>
      </div>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="panel">
      <div class="header">
        Output
        <div class="sub">Text oder Dashboard wird hier angezeigt</div>
      </div>

      <div id="output" class="out">
        <div class="hint">Noch keine Antwort. Sende links eine Frage.</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // KONFIGURATION - Hier deine n8n Webhook URL eintragen
    // ============================================================
    const CONFIG = {
      // Ersetze mit deiner n8n Webhook URL
      WEBHOOK_URL: "https://yraq0l4j.rpcld.cc/webhook/rfq-chat",
      
      // Timeout in Millisekunden (Dashboard-Generierung kann dauern)
      TIMEOUT: 120000  // 2 Minuten
    };

    // ============================================================
    // DOM Elements
    // ============================================================
    const chatlog = document.getElementById('chatlog');
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    // ============================================================
    // Chat Functions
    // ============================================================
    function addMsg(role, text, extraClass = '') {
      const div = document.createElement('div');
      div.className = `msg ${role} ${extraClass}`.trim();
      div.innerHTML = text;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
    }

    function showLoading() {
      output.innerHTML = `
        <div class="card">
          <div class="loading">
            <div class="spinner"></div>
            <span>Verarbeite Anfrage...</span>
          </div>
        </div>
      `;
    }

    // ============================================================
    // Output Display Functions
    // ============================================================
    
    // Zeigt eine Text-Antwort an
    function showTextAnswer(text) {
      // Formatiere den Text (ZeilenumbrÃ¼che, etc.)
      const formatted = escapeHtml(text)
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      output.innerHTML = `
        <div class="card">
          <div class="tag">Antwort</div>
          <div class="answer-text">${formatted}</div>
        </div>
      `;
    }

    // Zeigt ein Dashboard als inline HTML an
    function showDashboardInline(htmlContent, title = 'Dashboard') {
      // Erstelle einen iframe mit dem HTML als srcdoc
      output.innerHTML = `
        <div class="card">
          <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>
          <div class="dashboard-container">
            <iframe srcdoc="${escapeHtml(htmlContent)}" sandbox="allow-scripts allow-same-origin"></iframe>
          </div>
        </div>
      `;
    }

    // Zeigt ein Dashboard via URL (falls n8n eine URL zurÃ¼ckgibt)
    function showDashboardUrl(url, title = 'Dashboard') {
      output.innerHTML = `
        <div class="card">
          <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>
          <div class="dashboard-container">
            <iframe src="${escapeHtml(url)}"></iframe>
          </div>
        </div>
      `;
    }

    // Zeigt einen Fehler an
    function showError(message) {
      output.innerHTML = `
        <div class="card">
          <div class="tag error">Fehler</div>
          <div class="answer-text">${escapeHtml(message)}</div>
        </div>
      `;
    }

    // ============================================================
    // Utility Functions
    // ============================================================
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ============================================================
    // n8n API Call
    // ============================================================
    async function callN8N(message) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

      try {
        const response = await fetch(CONFIG.WEBHOOK_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            message: message,
            timestamp: new Date().toISOString()
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        // Lese immer zuerst als Text (fÃ¼r besseres Error Handling)
        const rawText = await response.text();

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${rawText || 'Keine Details'}`);
        }

        // Versuche JSON zu parsen
        if (!rawText || rawText.trim() === '') {
          return { type: "text", answer: "Leere Antwort vom Server erhalten." };
        }

        try {
          return JSON.parse(rawText);
        } catch (parseError) {
          // Falls kein JSON, behandle es als plain text
          return { type: "text", answer: rawText };
        }

      } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
          throw new Error('Timeout: Die Anfrage hat zu lange gedauert.');
        }
        throw error;
      }
    }

    // ============================================================
    // Main Send Handler
    // ============================================================
    async function onSend() {
      const msg = input.value.trim();
      if (!msg) return;

      // Clear input & disable button
      input.value = '';
      sendBtn.disabled = true;

      // Add user message to chat
      addMsg('user', escapeHtml(msg));
      
      // Show loading state
      showLoading();

      try {
        const response = await callN8N(msg);

        // Handle different response types
        switch (response.type) {
          case 'text':
            addMsg('bot', escapeHtml(response.answer || 'Keine Antwort'));
            showTextAnswer(response.answer || 'Keine Antwort erhalten.');
            break;

          case 'dashboard':
            // Dashboard kann entweder HTML-Content oder eine URL enthalten
            if (response.html) {
              addMsg('bot', `âœ… Dashboard "${response.title || 'Dashboard'}" wurde erstellt`, 'success');
              showDashboardInline(response.html, response.title);
            } else if (response.url) {
              addMsg('bot', `âœ… Dashboard "${response.title || 'Dashboard'}" ist bereit`, 'success');
              showDashboardUrl(response.url, response.title);
            } else {
              throw new Error('Dashboard-Antwort enthÃ¤lt weder HTML noch URL');
            }
            break;

          default:
            // Fallback: Behandle als Text
            const fallbackText = response.answer || response.text || response.output || JSON.stringify(response);
            addMsg('bot', escapeHtml(fallbackText));
            showTextAnswer(fallbackText);
        }

      } catch (error) {
        console.error('Error:', error);
        addMsg('bot', `âŒ ${escapeHtml(error.message)}`, 'error');
        showError(error.message);
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    // ============================================================
    // Event Listeners
    // ============================================================
    sendBtn.addEventListener('click', onSend);
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        onSend();
      }
    });

    // Focus input on load
    input.focus();
  </script>
</body>
</html>
