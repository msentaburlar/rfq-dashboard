<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Datenanalyse mit AI</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --border: #e9edf3;
      --text: #1f2937;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); }

    .app {
      display: grid;
      grid-template-columns: 420px 1fr;
      height: 100vh;
      gap: 16px;
      padding: 16px;
    }

    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      background: var(--card-bg);
    }

    .sub {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .chatlog { padding: 14px 16px; overflow: auto; flex: 1; }

    .msg {
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 90%;
      line-height: 1.45;
      font-size: 14px;
    }

    .user { background: #e8f0ff; margin-left: auto; border-bottom-right-radius: 4px; }
    .bot { background: #f3f4f6; border-bottom-left-radius: 4px; }
    .bot.error { background: #fef2f2; color: #b91c1c; }
    .bot.success { background: #f0fdf4; color: #166534; }

    .composer {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    textarea {
      flex: 1;
      resize: none;
      border: 1px solid #d6dde8;
      border-radius: 10px;
      padding: 12px;
      height: 48px;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    textarea:focus { border-color: var(--primary); }

    button {
      border: 0;
      background: var(--primary);
      color: white;
      padding: 0 20px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) { background: var(--primary-hover); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .out { padding: 14px 16px; overflow: auto; flex: 1; }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin: 10px 0;
      background: var(--card-bg);
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tag.dashboard { background: #f0fdf4; color: #166534; }
    .tag.error { background: #fef2f2; color: #b91c1c; }

    .hint { color: var(--text-muted); font-size: 13px; }

    .dashboard-container {
      width: 100%;
      min-height: 500px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
      position: relative;
    }

    .dashboard-container iframe {
      width: 100%;
      height: 75vh;
      border: none;
      border-radius: 12px;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .answer-content { line-height: 1.7; font-size: 14px; }
    .answer-content h1, .answer-content h2, .answer-content h3 { margin: 16px 0 8px 0; color: var(--text); font-weight: 600; }
    .answer-content h2 { color: var(--primary); }
    .answer-content table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    .answer-content thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .answer-content th { padding: 12px 14px; text-align: left; font-weight: 600; }
    .answer-content td { padding: 10px 14px; border-bottom: 1px solid #eee; }
    .answer-content tbody tr:hover { background: #f8fafc; }
    .answer-content ul, .answer-content ol { margin: 12px 0; padding-left: 24px; }
    .answer-content li { margin: 6px 0; }
    .answer-content strong { color: var(--primary); }

    /* Refresh Button fÃ¼r Dashboard */
    .refresh-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .refresh-btn:hover { background: var(--primary-hover); }

    /* GitHub Pages Hinweis */
    .github-note {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 8px;
    }
    .github-note a {
      color: var(--primary);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: CHAT -->
    <div class="panel">
      <div class="header">
         Datenanalyse & Dashboard
        <div class="sub"> Frage eingeben â€“ Analyse und Visualisierung erhalten</div>
      </div>

      <div id="chatlog" class="chatlog">
        <div class="msg bot">
          Hi! Stell z.B. eine Frage oder bitte um ein Dashboard mit Diagramm und Tabelle.
        </div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Schreibe deine Frage..."></textarea>
        <button id="send">Senden</button>
      </div>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="panel">
      <div class="header">
        Output
        <div class="sub">Text oder Dashboard wird hier angezeigt</div>
      </div>

      <div id="output" class="out">
        <div class="hint">Noch keine Antwort. Sende links eine Frage.</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // KONFIGURATION
    // ============================================================
    const CONFIG = {
      WEBHOOK_URL: "https://yraq0l4j.rpcld.cc/webhook/rfq-chat",
      DASHBOARD_BASE_URL: "https://msentaburlar.github.io/rfq-dashboard/dashboard.html",
      TIMEOUT: 120000,
      GITHUB_PAGES_DELAY: 3000
    };

    // ============================================================
    // Marked.js konfigurieren
    // ============================================================
    marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });

    // ============================================================
    // DOM Elements
    // ============================================================
    const chatlog = document.getElementById('chatlog');
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    // Chart instances (Chart.js)
    let chartInstances = {};

    // Speichere die aktuelle Dashboard-URL (alte Logik)
    let currentDashboardUrl = null;

    // ============================================================
    // Chat Functions
    // ============================================================
    function addMsg(role, text, extraClass = '') {
      const div = document.createElement('div');
      div.className = `msg ${role} ${extraClass}`.trim();
      div.innerHTML = text;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
    }

    function showLoading() {
      output.innerHTML = `
        <div class="card">
          <div class="loading">
            <div class="spinner"></div>
            <span>Verarbeite Anfrage...</span>
          </div>
        </div>
      `;
    }

    // ============================================================
    // Output Display Functions
    // ============================================================
    function showTextAnswer(text) {
      const htmlContent = marked.parse(text || "");
      output.innerHTML = `
        <div class="card">
          <div class="tag">Antwort</div>
          <div class="answer-content">${htmlContent}</div>
        </div>
      `;
    }

    // ============================================================
    // NEW: Dashboard Update Rendering (KPIs + Charts + Table)
    // ============================================================
    function showDashboardUpdate(payload) {
      const title = payload.title || "Dashboard";
      const answer = payload.answer || "";

      output.innerHTML = `
        <div class="card">
          <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>

          ${answer ? `<div class="answer-content">${marked.parse(answer)}</div>` : ""}

          <div id="kpi-grid"></div>
          <div id="charts-area"></div>
          <div id="table-area"></div>
        </div>
      `;

      renderKpis(payload.kpis || []);
      renderCharts(payload.charts || []);
      renderTable(payload.table || null);
    }

    function renderKpis(kpis) {
      const el = document.getElementById("kpi-grid");
      if (!el) return;

      if (!kpis.length) { el.innerHTML = ""; return; }

      el.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px;">
          ${kpis.map(k => `
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;">
              <div style="font-size:12px;color:var(--text-muted);font-weight:600;">${escapeHtml(k.label || "")}</div>
              <div style="font-size:20px;font-weight:800;margin-top:6px;">${escapeHtml(k.value || "")}</div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function renderCharts(charts) {
      const el = document.getElementById("charts-area");
      if (!el) return;

      // alte Charts zerstÃ¶ren
      Object.values(chartInstances).forEach(ch => { try { ch.destroy(); } catch (e) {} });
      chartInstances = {};

      if (!charts.length) { el.innerHTML = ""; return; }

      el.innerHTML = charts.map((c, idx) => {
        const id = c.id || ("chart" + (idx+1));
        return `
          <div style="margin-top:14px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;">
            <div style="font-weight:800;margin-bottom:10px;">${escapeHtml(c.title || ("Chart " + (idx+1)))}</div>
            <div style="height:280px;">
              <canvas id="${escapeHtml(id)}"></canvas>
            </div>
          </div>
        `;
      }).join("");

      charts.forEach((c, idx) => {
        const id = c.id || ("chart" + (idx+1));
        const canvas = document.getElementById(id);
        if (!canvas) return;

        const chartType = (c.chartType || "bar").toLowerCase();
        const labels = c.labels || [];
        const series = c.series || [];

        const datasets = series.map(s => ({
          label: s.name || "Serie",
          data: (s.data || []).map(v => (typeof v === "string" ? Number(v) : v))
        }));

        chartInstances[id] = new Chart(canvas.getContext("2d"), {
          type: chartType,
          data: { labels, datasets },
          options: { responsive: true, maintainAspectRatio: false }
        });
      });
    }

    function renderTable(table) {
      const el = document.getElementById("table-area");
      if (!el) return;

      if (!table || !table.columns || !table.rows) { el.innerHTML = ""; return; }

      el.innerHTML = `
        <div style="margin-top:14px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;">
          <div style="padding:10px 12px;font-weight:800;border-bottom:1px solid var(--border);">Tabelle</div>
          <div class="answer-content" style="padding:0;">
            <table>
              <thead>
                <tr>${table.columns.map(col => `<th>${escapeHtml(col)}</th>`).join("")}</tr>
              </thead>
              <tbody>
                ${table.rows.map(r => `
                  <tr>${r.map(cell => `<td>${escapeHtml(String(cell))}</td>`).join("")}</tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ============================================================
    // Alte Dashboard-Logik (html/url) bleibt drin, stÃ¶rt nicht
    // ============================================================
    function showDashboardInline(htmlContent, title = 'Dashboard') {
      output.innerHTML = `
        <div class="card">
          <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>
          <div class="dashboard-container">
            <iframe srcdoc="${escapeHtml(htmlContent)}" sandbox="allow-scripts allow-same-origin"></iframe>
          </div>
        </div>
      `;
    }

    function showDashboardUrl(url, title = 'Dashboard') {
      const cacheBustedUrl = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      currentDashboardUrl = cacheBustedUrl;

      output.innerHTML = `
        <div class="card">
          <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>
          <div class="dashboard-container">
            <button class="refresh-btn" onclick="refreshDashboard()">ðŸ”„ Aktualisieren</button>
            <iframe id="dashboard-iframe" src="${cacheBustedUrl}"></iframe>
          </div>
          <div class="github-note">
            Dashboard URL: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>
          </div>
        </div>
      `;
    }

    function showDashboardUrlWithDelay(url, title = 'Dashboard') {
      output.innerHTML = `
        <div class="card">
          <div class="tag dashboard">ðŸ“Š ${escapeHtml(title)}</div>
          <div class="dashboard-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px;">
            <div class="loading">
              <div class="spinner"></div>
              <span>Dashboard wird bereitgestellt...</span>
            </div>
            <p style="color: var(--text-muted); font-size: 12px; margin-top: 12px;">
              Bitte warten...
            </p>
          </div>
        </div>
      `;

      setTimeout(() => {
        showDashboardUrl(url, title);
      }, CONFIG.GITHUB_PAGES_DELAY);
    }

    window.refreshDashboard = function() {
      const iframe = document.getElementById('dashboard-iframe');
      if (!iframe) return;
      const base = (currentDashboardUrl || CONFIG.DASHBOARD_BASE_URL).split('?')[0];
      const newUrl = base + '?t=' + Date.now();
      iframe.src = newUrl;
      currentDashboardUrl = newUrl;
    };

    function showError(message) {
      output.innerHTML = `
        <div class="card">
          <div class="tag error">Fehler</div>
          <div class="answer-content">${escapeHtml(message)}</div>
        </div>
      `;
    }

    // ============================================================
    // Utility Functions
    // ============================================================
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Robust JSON Parsing
    function parseN8nResponse(rawText) {
      if (!rawText || rawText.trim() === '') {
        return { type: "text", answer: "Leere Antwort vom Server erhalten." };
      }

      try {
        const parsed = JSON.parse(rawText);

        // If wrapped inside "output" string
        if (parsed && typeof parsed === 'object' && typeof parsed.output === 'string') {
          const inner = parsed.output.trim();
          try { return JSON.parse(inner); } catch (e1) {}
          const unquoted = inner.replace(/^"+|"+$/g, '');
          try { return JSON.parse(unquoted); } catch (e2) {}
          return { type: "text", answer: inner };
        }

        return parsed;
      } catch (e) {
        return { type: "text", answer: rawText };
      }
    }

    // ============================================================
    // n8n API Call
    // ============================================================
    async function callN8N(message) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

      try {
        const response = await fetch(CONFIG.WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: message,
            timestamp: new Date().toISOString()
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const rawText = await response.text();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${rawText || 'Keine Details'}`);
        }

        return parseN8nResponse(rawText);

      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Timeout: Die Anfrage hat zu lange gedauert.');
        }
        throw error;
      }
    }

    // ============================================================
    // Main Send Handler
    // ============================================================
    async function onSend() {
      const msg = input.value.trim();
      if (!msg) return;

      input.value = '';
      sendBtn.disabled = true;
      addMsg('user', escapeHtml(msg));
      showLoading();

      try {
        const response = await callN8N(msg);

        switch (response.type) {
          case 'text':
            addMsg('bot', 'Antwort erhalten âœ“');
            showTextAnswer(response.answer || 'Keine Antwort erhalten.');
            break;

          case 'dashboard_update':
            addMsg('bot', 'âœ… Dashboard aktualisiert', 'success');
            showDashboardUpdate(response);
            break;

          case 'dashboard': // alte Logik optional
            if (response.html) {
              addMsg('bot', `âœ… Dashboard "${response.title || 'Dashboard'}" wurde erstellt`, 'success');
              showDashboardInline(response.html, response.title);
            } else if (response.url) {
              addMsg('bot', `âœ… Dashboard "${response.title || 'Dashboard'}" ist bereit`, 'success');
              showDashboardUrlWithDelay(response.url, response.title);
            } else {
              throw new Error('Dashboard-Antwort enthÃ¤lt weder HTML noch URL');
            }
            break;

          default: {
            const fallbackText =
              response.answer ||
              response.text ||
              response.output ||
              JSON.stringify(response, null, 2);

            addMsg('bot', 'Antwort erhalten');
            showTextAnswer(fallbackText);
            break;
          }
        }

      } catch (error) {
        console.error('Error:', error);
        addMsg('bot', `âŒ ${escapeHtml(error.message)}`, 'error');
        showError(error.message);
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    // ============================================================
    // Event Listeners
    // ============================================================
    sendBtn.addEventListener('click', onSend);

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        onSend();
      }
    });

    input.focus();
  </script>
</body>
</html>
